<?php
class BibdkCartTestCase extends DrupalWebTestCase {

  public static function getInfo() {
    return array(
      'name' => t('Bibdk Cart test'),
      'description' => t('Test Cart functionality'),
      'group' => t('Bibliotek.dk - Cart'),
    );
  }

  public function setUp() {
    $this->profile = 'minimal';
    parent::setUp('bibdk_cart', 'bibdk_provider', 'ding_persistent_login', 'ting_openformat', 'bibdk_webservice');
    variable_set('ting_search_url', 'lakiseks.dbc.dk/openbibdk/0.5/');
    //variable_set('bibdk_provider_webservice_url', $this->getAbsoluteUrl('/bibdk_cart_webservice'));
    variable_set('bibdk_provider_webservice_url', $this->getAbsoluteUrl('bibdk_webservice'));
    variable_set('bibdk_provider_security_code', 'securityCode');
    // Fake provider user
    $this->_createProviderUser();

  }

  public function testRunner(){
    $this->testAjaxReesponse();
    $this->testBibdkCartObjectNoUser();
    $this->testWebserviceMethods();
    $this->testBibdkCartUserLogin();
  }

  private function testBibdkCartUserLogin(){
    //Reset cart count
    bibdk_webservice_request(true);
    // Create dummy provider user
    $user = new stdClass();
    $user->uid = 1;
    $user->name = 'good_user';
    ding_user_save_creds(array('creds' => array(
      'name' => 'good_user',
      'pass' => 'password',
    )), $user);

    // reset session
    $_SESSION['bibdk_cart'] = null;
    $edit = array();

    // Session should be updated with content from webservice
    bibdk_cart_user_login($edit, $user);
    $expected_result = array (
      '870970-basis:06343570' => '870970-basis:06343570',
      '820010-katalog:5025393' => '820010-katalog:5025393',
      '820010-katalog:3674811' => '820010-katalog:3674811',
      '820010-katalog:2266809' => '820010-katalog:2266809',
      '830370-katalog:AH9900827' => '830370-katalog:AH9900827',
      '820030-katalog:804671' => '820030-katalog:804671',
      '870970-basis:06042457' => '870970-basis:06042457',
      '870970-basis:07121377' => '870970-basis:07121377',
      '870970-basis:29317038,870970-basis:25194853,870970-basis:22441671,870970-basis:22629344,870970-basis:22252852,870970-basis:26178533' => '870970-basis:29317038,870970-basis:25194853,870970-basis:22441671,870970-basis:22629344,870970-basis:22252852,870970-basis:26178533',
    );
    $this->assertEqual($_SESSION['bibdk_cart'], $expected_result, 'Session is updated with cart content from webservice');

    // Existing objects in session should be merged with webservice content
    $_SESSION['bibdk_cart'] = array(
      'test' => 'test:basis-pid',
    );
    $expected_result = $_SESSION['bibdk_cart'] + $expected_result;
    bibdk_cart_user_login($edit, $user);
    $this->assertEqual($_SESSION['bibdk_cart'], $expected_result, 'Session is updated with cart content from webservice');

    // Nothing should happen with the Session if not provider user
    $expected_result = $_SESSION['bibdk_cart'] = array(
      'test' => 'test:basis-pid',
    );
    $user->uid = 5;
    bibdk_cart_user_login($edit, $user);
    $this->assertEqual($_SESSION['bibdk_cart'], $expected_result, 'Session is unchanged');
  }

  private function testWebserviceMethods(){
    //Reset cart count
    bibdk_webservice_request(true);
    // Create dummy provider user
      $user = new stdClass();
      $user->uid = 1;
      $user->name = 'good_user';
      ding_user_save_creds(array('creds' => array(
        'name' => 'good_user',
        'pass' => 'password',
      )), $user);

    // Create dummy anonymous user
    $anonymous = new stdClass();
    $anonymous->uid = 0;

    //Get cart from ding_provider user
    $result = _bibdk_cart_get_cart_on_webservice($user);
    $this->assertTrue(count($result) == 9, 'Correct number on elements in returned for webservice');
    $this->assertTrue(reset($result) == '870970-basis:06343570', 'First element is a pid');

    //Get cart from anonymous user (no results)
    $result = _bibdk_cart_get_cart_on_webservice($anonymous);
    $this->assertFalse($result, 'No results from webservice');

    // add Content provider user
    $result = _bibdk_cart_add_content_webservice('123456789', $user);
    $this->assertEqual($result['status'], 'success', 'add content success');

    // add Content anonymous user
    $result = _bibdk_cart_add_content_webservice('123456789', $anonymous);
    $this->assertNotEqual($result['status'], 'success', 'no add content success');

    // remove Content provider user
    $result = _bibdk_cart_remove_content_webservice('123456789', $user);
    $this->assertEqual($result['status'], 'success', 'remove content success');

    // remove Content anonymous user
    $result = _bibdk_cart_remove_content_webservice('123456789', $anonymous);
    $this->assertNotEqual($result['status'], 'success', 'no remove content success');

  }

  private function _createProviderUser(){
    db_insert('authmap')
      ->fields(array(
      'uid' => 1,
      'module' => 'ding_user',
      'authname' => 'testusername',
    ))->execute();

  }

  private function testBibdkCartObjectNoUser(){
    BibdkCart::emptyCart();
    // empty cart
    $result = BibdkCart::getAll();
    $expected_result = array();
    $this->assertEqual($result, $expected_result);

    // test add
    BibdkCart::add('test1');
    BibdkCart::add(array('test2', 'test3'));
    $result = BibdkCart::getAll();
    $expected_result = array(
      'test1' => 'test1',
      'test2' => 'test2',
      'test3' => 'test3',
    );
    $this->assertEqual($result, $expected_result, 'objects added');

    // test remove
    BibdkCart::remove('test1');
    BibdkCart::remove(array('test2'));
    $result = BibdkCart::getAll();
    $expected_result = array(
      'test3' => 'test3',
    );
    $this->assertEqual($result, $expected_result, 'objects removed');

    // test checkInCart
    $this->assertTrue(BibdkCart::checkInCart('test3'), 'testObject 3 exists in card');
    $this->assertFalse(BibdkCart::checkInCart('test1'), 'testObject 1 does not exists in card');


    // test empty cart
    BibdkCart::emptyCart();
    $result = BibdkCart::getAll();
    $expected_result = array();
    $this->assertEqual($result, $expected_result);

  }

  /**
   * Tests the output data of bibdk_adhl.ajax.inc
   */
  private function testAjaxReesponse() {
    //add to cart
    $pid = '870970-basis:29225605';
    $url = $this->getAbsoluteUrl('cart/ajax');
    $options = array(
      'query' => array(
        'pid' => $pid,
      ),
    );
    $result = $this->drupalGetAJAX($url, $options);
    $this->assertEqual($result['pid'], $pid, 'Received pid correctly');
    $this->assertEqual($result['cartcount'], 1, 'Correct amount in cart: 1');
    $this->assertEqual($result['saved'], 1, 'Correctly saved in cart');
    $this->assertEqual($result['classid'], strtolower(strtr($pid, array(':' => '-'))), 'Correct classid specified');

    //remove from cart
    $pid = '870970-basis:29225605';
    $url = $this->getAbsoluteUrl('cart/ajax');
    $options = array(
      'query' => array(
        'pid' => $pid,
      ),
    );
    $result = $this->drupalGetAJAX($url, $options);
    $this->drupalGetAJAX($url, $options);
    $this->assertEqual($result['pid'], $pid, 'Received pid correctly');
    $this->assertEqual($result['cartcount'], 0, 'Correct amount in cart: 0');
    $this->assertEqual($result['saved'], 0, 'Correctly removed from cart');
    $this->assertEqual($result['classid'], strtolower(strtr($pid, array(':' => '-'))), 'Correct classid specified');
  }
}
