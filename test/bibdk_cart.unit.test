<?php

class BibdkCartUnitTestCase extends DrupalUnitTestCase {
  public static function getInfo() {
    return array(
      'name' => t('Bibdk Cart Unittests'),
      'description' => t('Unit testing bibdk_cart'),
      'group' => t('Bibliotek.dk - Cart'),
    );
  }

  public function setUp() {
    parent::setUp();
  }

  // Testing methods in bibdk_cart.webservice.inc

  /**
   * Testing method bibdk_cart_webservice_responce_xpath()
   */
  public function test_bibdk_cart_parse_cart_count_response(){
    module_load_include('inc', 'bibdk_cart', 'includes/bibdk_cart.webservice');
    $response = drupal_json_decode(file_get_contents(drupal_get_path('module', 'bibdk_cart') . '/test/responses/get_cart_count_response.json'));
    $xpath = bibdk_cart_webservice_responce_xpath($response['response']);
    $result = bibdk_cart_parse_cart_count_response($xpath);

    $this->assertTrue(is_array($result), 'Got array');
    $this->assertTrue(array_key_exists('cartCount', $result), 'Array contains a key named cartCount');
    $this->assertTrue(is_array($result), 'Got array');
  }

  //  Testing methods in bibdk_cart.module

  public function test_bibdk_cart_get_pager(){
    module_load_include('module', 'bibdk_cart');

    //one page in total - current page is first page
    $result = _bibdk_cart_get_pager(1, 1);
    $expected = array (
      '#theme' => 'html_tag',
      '#tag' => 'div',
      '#value' => '<a href="/sandbox/user/cart?page=1" class="bold">1</a>',
      '#attributes' =>
        array (
          'id' =>
            array (
              0 => 'bibdk-cart-pager',
            ),
        ),
    );
    $this->assertEqual($result, $expected, 'Arrays are itentical');

    //20 pages in total - current page is first page
    $result = _bibdk_cart_get_pager(20, 1);
    $expected = array (
      '#theme' => 'html_tag',
      '#tag' => 'div',
      '#value' => '<a href="/sandbox/user/cart?page=1" class="bold">1</a><a href="/sandbox/user/cart?page=2">2</a><a href="/sandbox/user/cart?page=3">3</a><a href="/sandbox/user/cart?page=4">4</a><a href="/sandbox/user/cart?page=5">5</a><a href="/sandbox/user/cart?page=6">6</a><a href="/sandbox/user/cart?page=7">7</a><a href="/sandbox/user/cart?page=8">8</a><a href="/sandbox/user/cart?page=9">9</a><a href="/sandbox/user/cart?page=10">10</a>...<a href="/sandbox/user/cart?page=20">20</a><a href="/sandbox/user/cart?page=2">next &gt;</a>',
      '#attributes' =>
        array (
          'id' =>
            array (
              0 => 'bibdk-cart-pager',
            ),
        ),
    );
    $this->assertEqual($result, $expected, 'Arrays are itentical');

    //20 pages in total - current page is 5th page
    $result = _bibdk_cart_get_pager(20, 5);
    $expected = array (
      '#theme' => 'html_tag',
      '#tag' => 'div',
      '#value' => '<a href="/sandbox/user/cart?page=1">1</a><a href="/sandbox/user/cart?page=2">2</a><a href="/sandbox/user/cart?page=3">3</a><a href="/sandbox/user/cart?page=4">4</a><a href="/sandbox/user/cart?page=5" class="bold">5</a><a href="/sandbox/user/cart?page=6">6</a><a href="/sandbox/user/cart?page=7">7</a><a href="/sandbox/user/cart?page=8">8</a><a href="/sandbox/user/cart?page=9">9</a><a href="/sandbox/user/cart?page=10">10</a>...<a href="/sandbox/user/cart?page=20">20</a><a href="/sandbox/user/cart?page=6">next &gt;</a>',
      '#attributes' =>
        array (
          'id' =>
            array (
              0 => 'bibdk-cart-pager',
            ),
        ),
    );
    $this->assertEqual($result, $expected, 'Arrays are itentical');

    //20 pages in total - current page is 10th page
    $result = _bibdk_cart_get_pager(20, 10);
    $expected = array (
      '#theme' => 'html_tag',
      '#tag' => 'div',
      '#value' => '<a href="/sandbox/user/cart?page=9">&lt; previous</a><a href="/sandbox/user/cart?page=1">1</a>...<a href="/sandbox/user/cart?page=6">6</a><a href="/sandbox/user/cart?page=7">7</a><a href="/sandbox/user/cart?page=8">8</a><a href="/sandbox/user/cart?page=9">9</a><a href="/sandbox/user/cart?page=10" class="bold">10</a><a href="/sandbox/user/cart?page=11">11</a><a href="/sandbox/user/cart?page=12">12</a><a href="/sandbox/user/cart?page=13">13</a><a href="/sandbox/user/cart?page=14">14</a>...<a href="/sandbox/user/cart?page=20">20</a><a href="/sandbox/user/cart?page=11">next &gt;</a>',
      '#attributes' =>
        array (
          'id' =>
            array (
              0 => 'bibdk-cart-pager',
            ),
        ),
    );
    $this->assertEqual($result, $expected, 'Arrays are itentical');

    //20 pages in total - current page is 15th page
    $result = _bibdk_cart_get_pager(20, 15);
    $expected = array (
      '#theme' => 'html_tag',
      '#tag' => 'div',
      '#value' => '<a href="/sandbox/user/cart?page=14">&lt; previous</a><a href="/sandbox/user/cart?page=1">1</a>...<a href="/sandbox/user/cart?page=11">11</a><a href="/sandbox/user/cart?page=12">12</a><a href="/sandbox/user/cart?page=13">13</a><a href="/sandbox/user/cart?page=14">14</a><a href="/sandbox/user/cart?page=15" class="bold">15</a><a href="/sandbox/user/cart?page=16">16</a><a href="/sandbox/user/cart?page=17">17</a><a href="/sandbox/user/cart?page=18">18</a><a href="/sandbox/user/cart?page=19">19</a><a href="/sandbox/user/cart?page=20">20</a>',
      '#attributes' =>
        array (
          'id' =>
            array (
              0 => 'bibdk-cart-pager',
            ),
        ),
    );
    $this->assertEqual($result, $expected, 'Arrays are itentical');

    //20 pages in total - current page is 20th page
    $result = _bibdk_cart_get_pager(20, 20);
    $expected = array (
      '#theme' => 'html_tag',
      '#tag' => 'div',
      '#value' => '<a href="/sandbox/user/cart?page=19">&lt; previous</a><a href="/sandbox/user/cart?page=1">1</a>...<a href="/sandbox/user/cart?page=11">11</a><a href="/sandbox/user/cart?page=12">12</a><a href="/sandbox/user/cart?page=13">13</a><a href="/sandbox/user/cart?page=14">14</a><a href="/sandbox/user/cart?page=15">15</a><a href="/sandbox/user/cart?page=16">16</a><a href="/sandbox/user/cart?page=17">17</a><a href="/sandbox/user/cart?page=18">18</a><a href="/sandbox/user/cart?page=19">19</a><a href="/sandbox/user/cart?page=20" class="bold">20</a>',
      '#attributes' =>
        array (
          'id' =>
            array (
              0 => 'bibdk-cart-pager',
            ),
        ),
    );
    $this->assertEqual($result, $expected, 'Arrays are itentical');

    //Total count of pages is lover than current page
    $result = _bibdk_cart_get_pager(1, 20);
    $expected = array (
      '#theme' => 'html_tag',
      '#tag' => 'div',
      '#value' => '<a href="/sandbox/user/cart?page=19">&lt; previous</a><a href="/sandbox/user/cart?page=1">1</a>...',
      '#attributes' =>
        array (
          'id' =>
            array (
              0 => 'bibdk-cart-pager',
            ),
        ),
    );
    $this->assertEqual($result, $expected, 'Arrays are itentical');
  }
}
